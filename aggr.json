[
  {
    "$match": {
      "deleted": false,
      "_type": "Actors::Organization",
      "parent_id": "6786644dec97083e68ac021b"
    }
  },
  {
    "$project": {
      "_id": 1,
      "_type": 1,
      "path": 1,
      "title": 1,
      "parent_id": 1,
      "parent_ids": 1
    }
  },
  {
    "$lookup": {
      "from": "actors",
      "localField": "_id",
      "foreignField": "parent_ids",
      "as": "groups",
      "pipeline": [
        {
          "$match": {
            "_type": "Actors::Group",
            "deleted": false
          }
        },
        {
          "$project": {
            "_id": 1,
            "name": 1,
            "_type": 1,
            "path": 1,
            "title": 1,
            "parent_id": 1,
            "parent_ids": 1,
            "role_ids": 1
          }
        }
      ]
    }
  },
  {
    "$unwind": {
      "path": "$groups"
    }
  },
  {
    "$replaceRoot": {
      "newRoot": "$groups"
    }
  },
  {
    "$lookup": {
      "from": "actors",
      "localField": "parent_id",
      "foreignField": "_id",
      "as": "parent",
      "pipeline": [
        {
          "$match": {
            "deleted": false
          }
        },
        {
          "$project": {
            "title": 1,
            "name": 1
          }
        }
      ]
    }
  },
  {
    "$addFields": {
      "parent": {
        "$first": "$parent"
      }
    }
  },
  {
    "$lookup": {
      "from": "roles",
      "localField": "role_ids",
      "foreignField": "_id",
      "as": "roles",
      "pipeline": [
        {
          "$project": {
            "title": 1,
            "description": 1
          }
        }
      ]
    }
  },
  {
    "$project": {
      "_id": 0,
      "id": {
        "$toString": "$_id"
      },
      "name": 1,
      "group_name": "$parent.name",
      "group": {
        "$getField": {
          "field": "de",
          "input": "$parent.title"
        }
      },
      "label": {
        "$getField": {
          "field": "de",
          "input": "$title"
        }
      },
      "role_ids": "$roles._id",
      "description": {
        "$reduce": {
          "input": {
            "$setUnion": "$roles.description.de"
          },
          "initialValue": "",
          "in": {
            "$concat": [
              "$$value",
              {
                "$cond": [
                  {
                    "$eq": [
                      "$$value",
                      ""
                    ]
                  },
                  "",
                  "\n"
                ]
              },
              "$$this"
            ]
          }
        }
      }
    }
  },
  {
    "$sort": {
      "group": 1,
      "label": 1
    }
  }
]
